<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
  <title>Sungabha Awasiya Ma.Vi. Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="logo.png">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * {
      font-family: 'Inter', sans-serif;
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: auto;
      font-size: 16px;
      -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
      position: relative;
      width: 100%;
      background: #1C2526; /* Almost Black */
      -webkit-tap-highlight-color: transparent;
    }

    input, textarea, select {
      font-size: 16px !important;
      -webkit-appearance: none;
      border-radius: 0;
    }

    /* Glassmorphism Effects */
    .glass {
      backdrop-filter: blur(20px);
      background: rgba(245, 245, 245, 0.3); /* Off-White with higher opacity */
      border: 1px solid rgba(245, 245, 245, 0.4);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    .glass-dark {
      backdrop-filter: blur(20px);
      background: rgba(28, 37, 38, 0.5); /* Almost Black with higher opacity */
      border: 1px solid rgba(245, 245, 245, 0.3);
    }

    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #B0C4DE; /* Cool Gray */
      border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #FFD700; /* Golden Yellow */
    }

    /* Message Bubble */
    .message-appear {
      display: flex;
      flex-direction: column;
      margin-bottom: 1rem;
    }

    .message-bubble {
      max-width: 80%;
      font-size: 15px;
      line-height: 1.4;
      border-radius: 1.5rem;
      padding: 0.75rem 1rem;
      position: relative;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
    }

    .message-bubble.sent {
      background: #8B0000; /* Deep Crimson */
      color: #FFFDD0; /* Cream */
      margin-left: auto;
      border-bottom-right-radius: 0.375rem;
      box-shadow: 0 4px 20px rgba(139, 0, 0, 0.3);
    }

    .message-bubble.received {
      background: #F5F5F5; /* Off-White */
      color: #1C2526; /* Almost Black */
      margin-right: auto;
      border-bottom-left-radius: 0.375rem;
      backdrop-filter: blur(10px);
    }

    .message-bubble:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    /* File Message Styling */
    .file-message {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding: 0.5rem;
      background: rgba(245, 245, 245, 0.4);
      border-radius: 0.75rem;
      max-width: 80%;
    }

    .file-message img {
      max-width: 200px;
      max-height: 200px;
      border-radius: 0.5rem;
      object-fit: cover;
      border: 1px solid #808080; /* Medium Gray */
    }

    .file-message a {
      color: #FFD700; /* Golden Yellow */
      text-decoration: underline;
      word-break: break-all;
    }

    .file-message a:hover {
      color: #B0C4DE; /* Cool Gray */
    }

    /* Message Actions */
    .message-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.25rem;
      padding: 0.25rem 0.5rem;
      background: rgba(245, 245, 245, 0.3);
      border-radius: 1.25rem;
      backdrop-filter: blur(10px);
      opacity: 0;
      pointer-events: none;
      transform: translateY(10px);
      transition: all 0.3s ease;
      width: fit-content;
      max-width: 12rem;
    }

    .message-actions.sent {
      margin-left: auto;
    }

    .message-actions.received {
      margin-right: auto;
    }

    .message-bubble:hover + .message-actions,
    .message-actions:hover {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    .action-icon {
      cursor: pointer;
      color: #FFD700; /* Golden Yellow */
      font-size: 1rem;
      padding: 0.375rem;
      border-radius: 50%;
      transition: all 0.3s ease;
      animation: icon-pulse 1.5s infinite;
    }

    @keyframes icon-pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .action-icon:hover {
      background: rgba(255, 215, 0, 0.2);
      transform: scale(1.1);
    }

    /* Settings Toggle */
    .settings-toggle {
      position: relative;
      display: inline-block;
      width: 2.5rem;
      height: 1.25rem;
    }

    .settings-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #808080; /* Medium Gray */
      transition: 0.3s;
      border-radius: 1.25rem;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 1rem;
      width: 1rem;
      left: 0.125rem;
      bottom: 0.125rem;
      background-color: #F5F5F5; /* Off-White */
      transition: 0.3s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #8B0000; /* Deep Crimson */
    }

    input:checked + .slider:before {
      transform: translateX(1.25rem);
    }

    .slider:hover {
      background-color: #B0C4DE; /* Cool Gray */
    }

    input:checked + .slider:hover {
      background-color: #FFD700; /* Golden Yellow */
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      color: #FFFDD0;
      font-size: 14px;
      z-index: 1000;
      max-width: 300px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .toast-success {
      background: #FFD700; /* Golden Yellow */
      color: #1C2526; /* Almost Black */
    }

    .toast-error {
      background: #8B0000; /* Deep Crimson */
      color: #FFFDD0; /* Cream */
    }

    /* Reactions Display */
    .reactions-display {
      cursor: pointer;
    }

    /* Video Call Styles */
    .video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .remote-video {
      width: 100%;
      height: auto;
      background: black;
      border-radius: 8px;
      object-fit: cover;
    }

    .local-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
    }

    .call-control-btn {
      background: rgba(245, 245, 245, 0.3);
      color: #FFFDD0;
      padding: 0.75rem;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .call-control-btn:hover {
      background: #FFD700;
      color: #1C2526;
    }

    .call-control-btn.disabled {
      color: #8B0000;
    }

    /* Media Queries for Responsiveness */
    @media (max-width: 640px) {
      .message-bubble, .file-message {
        max-width: 85%;
        font-size: 0.875rem;
        padding: 0.625rem 0.875rem;
      }

      .file-message img {
        max-width: 150px;
        max-height: 150px;
      }

      .settings-toggle {
        width: 2.25rem;
        height: 1.125rem;
      }

      .slider:before {
        height: 0.875rem;
        width: 0.875rem;
        left: 0.125rem;
        bottom: 0.125rem;
      }

      input:checked + .slider:before {
        transform: translateX(1.125rem);
      }

      .toast {
        bottom: 10px;
        right: 10px;
        font-size: 12px;
        max-width: 90%;
      }

      #homeScreen .glass {
        padding: 4rem 2rem;
      }

      #chatContainer {
        flex-direction: column;
      }

      #usersPanel {
        position: fixed;
        top: 0;
        right: -100%;
        width: 80%;
        height: 100%;
        background: #F5F5F5;
        transition: right 0.3s ease;
        z-index: 30;
        padding: 1rem;
      }

      #usersPanel.open {
        right: 0;
      }
    }

    @media (min-width: 768px) {
      #chatContainer {
        max-width: 768px;
        margin: 0 auto;
      }

      #chatMain {
        flex: 1;
      }

      #usersPanel {
        width: 250px;
        border-left: 1px solid #808080;
      }
    }

    @media (min-width: 1024px) {
      #chatContainer {
        max-width: 1024px;
        margin: 0 auto;
      }

      .message-bubble {
        max-width: 70%;
      }

      .file-message img {
        max-width: 300px;
        max-height: 300px;
      }
    }
  </style>
</head>
<body class="bg-[#1C2526]">
  <!-- Home/Login Screen -->
  <div id="homeScreen" class="min-h-screen flex items-center justify-center p-4 bg-[#4169E1] overflow-y-auto">
    <div class="glass rounded-3xl p-6 w-full max-w-sm md:max-w-md shadow-2xl overflow-y-auto max-h-screen">
      <div class="text-center mb-6">
        <img src="logo.png" alt="Sungabha Awasiya Ma.Vi. Logo" class="w-12 h-12 md:w-16 md:h-16 mx-auto mb-4 rounded-full shadow-xl">
        <h1 class="text-2xl md:text-3xl font-bold text-[#FFFDD0]">Sungabha Chat</h1>
        <p class="text-[#F5F5F5] text-xs md:text-sm mt-2">Connect with the Sungabha community</p>
      </div>
      <div class="space-y-3 md:space-y-4">
        <div id="nameWrapper" class="relative">
          <input 
            id="usernameInput" 
            type="text" 
            placeholder="Enter your name" 
            class="w-full px-4 py-2 md:py-3 pl-12 rounded-xl bg-[#F5F5F5] text-[#1C2526] border-2 border-transparent focus:border-[#FFD700] focus:bg-[#FFFDD0] shadow-md text-sm"
            maxlength="30"
          >
          <i class="fas fa-user absolute left-4 top-1/2 transform -translate-y-1/2 text-[#808080]"></i>
        </div>
        <div class="relative">
          <input 
            id="emailInput" 
            type="email" 
            placeholder="Enter your email" 
            class="w-full px-4 py-2 md:py-3 pl-12 rounded-xl bg-[#F5F5F5] text-[#1C2526] border-2 border-transparent focus:border-[#FFD700] focus:bg-[#FFFDD0] shadow-md text-sm"
          >
          <i class="fas fa-envelope absolute left-4 top-1/2 transform -translate-y-1/2 text-[#808080]"></i>
        </div>
        <div class="relative">
          <input 
            id="passwordInput" 
            type="password" 
            placeholder="Enter your password (min 6 chars)" 
            class="w-full px-4 py-2 md:py-3 pl-12 pr-14 rounded-xl bg-[#F5F5F5] text-[#1C2526] border-2 border-transparent focus:border-[#FFD700] focus:bg-[#FFFDD0] shadow-md text-sm"
            minlength="6"
          >
          <i class="fas fa-lock absolute left-4 top-1/2 transform -translate-y-1/2 text-[#808080]"></i>
          <i id="passwordToggle" class="fas fa-eye absolute right-4 top-1/2 transform -translate-y-1/2 text-[#B0C4DE] cursor-pointer hover:text-[#FFD700] p-2"></i>
        </div>
        <button id="authBtn" class="w-full bg-[#8B0000] text-[#FFFDD0] font-semibold py-2 md:py-3 px-6 rounded-xl hover:bg-[#FFD700] hover:text-[#1C2526] transition-all disabled:opacity-50 disabled:cursor-not-allowed text-sm">
          <i class="fas fa-rocket mr-2"></i>
          Create Account
        </button>
        <p id="toggleAuth" class="text-center text-[#F5F5F5] cursor-pointer text-xs md:text-sm hover:text-[#FFD700] transition-colors">
          Already have an account? Sign In
        </p>
        <div class="relative">
          <div class="absolute inset-0 flex items-center">
            <div class="w-full border-t border-[#808080]"></div>
          </div>
          <div class="relative flex justify-center text-xs md:text-sm">
            <span class="px-2 bg-transparent text-[#B0C4DE]">or</span>
          </div>
        </div>
        <button id="googleBtn" class="w-full bg-[#F5F5F5] border border-[#808080] text-[#1C2526] font-semibold py-2 md:py-3 px-6 rounded-xl hover:bg-[#FFFDD0] hover:shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center text-sm">
          <i class="fab fa-google mr-2 text-[#8B0000]"></i>
          Sign in with Google
        </button>
        <p id="authMessage" class="text-center text-xs md:text-sm mt-4 hidden p-3 rounded-lg"></p>
      </div>
      <div class="text-center mt-6 md:mt-8 text-[#B0C4DE] text-xs">
        Developed by Laxman Poudel<br>
        <a href="https://iamlaxman.github.io/sungabha-school/" target="_blank" class="hover:text-[#FFD700] transition-colors">
          <i class="fas fa-school mr-1"></i>Sungabha Awasiya Ma.Vi.
        </a><br>
        <i class="fas fa-envelope mr-1"></i> ethical.laxman@gmail.com<br>
        <i class="fas fa-phone mr-1"></i> +9779867844454
      </div>
    </div>
  </div>

  <!-- Email Verification Screen -->
  <div id="verificationScreen" class="hidden min-h-screen flex items-center justify-center p-4 bg-[#4169E1] overflow-y-auto">
    <div class="glass rounded-3xl p-6 w-full max-w-sm md:max-w-md shadow-2xl text-center overflow-y-auto max-h-screen">
      <img src="logo.png" alt="Sungabha Awasiya Ma.Vi. Logo" class="w-12 h-12 md:w-16 md:h-16 mx-auto mb-4 rounded-full shadow-xl">
      <h2 class="text-2xl font-bold text-[#FFFDD0] mb-4">Verify Your Email</h2>
      <p class="text-[#F5F5F5] mb-6 text-xs md:text-sm">We have sent a verification email to your account. Check your mail and don't forget to check the spam section.</p>
      <div class="space-y-3 md:space-y-4">
        <button id="resendBtn" class="w-full bg-[#8B0000] text-[#FFFDD0] font-semibold py-2 md:py-3 px-6 rounded-xl hover:bg-[#FFD700] hover:text-[#1C2526] transition-all text-sm">
          <i class="fas fa-paper-plane mr-2"></i>
          Resend Verification Email
        </button>
        <button id="backToLoginBtn" class="w-full bg-[#FFFDD0] text-[#1C2526] font-semibold py-2 md:py-3 px-6 rounded-xl hover:bg-[#FFD700] transition-all text-sm">
          <i class="fas fa-arrow-left mr-2"></i>
          Back to Login
        </button>
      </div>
      <p id="verificationMessage" class="text-center text-xs md:text-sm mt-4 hidden p-3 rounded-lg"></p>
    </div>
  </div>

  <!-- Chat Container -->
  <div id="chatContainer" class="hidden h-screen bg-[#4169E1] md:max-w-3xl md:mx-auto lg:max-w-4xl flex flex-row">
    <div id="usersPanel" class="hidden lg:block w-64 bg-[#F5F5F5] border-r border-[#808080] p-4 overflow-y-auto custom-scrollbar">
      <h3 class="text-sm font-semibold text-[#1C2526] mb-2 flex items-center">
        <i class="fas fa-users mr-2"></i>
        Users
      </h3>
      <div id="activeUsersSection" class="mb-4">
        <h4 class="text-xs font-bold text-[#1C2526] mb-1">Active Users</h4>
        <div id="activeUsersList" class="flex flex-col gap-2"></div>
      </div>
      <div id="inactiveUsersSection">
        <h4 class="text-xs font-bold text-[#1C2526] mb-1">Registered Users (Inactive)</h4>
        <div id="inactiveUsersList" class="flex flex-col gap-2"></div>
      </div>
    </div>
    <div id="chatMain" class="flex flex-col flex-1">
      <div class="sticky top-0 z-20 bg-[#F5F5F5] backdrop-blur-xl border-b border-[#808080] shadow-md p-4 flex items-center justify-between">
        <div class="flex items-center space-x-3 flex-nowrap">
          <button id="backBtn" class="p-2 hover:bg-[#FFFDD0] rounded-full transition-colors">
            <i class="fas fa-arrow-left text-[#1C2526]"></i>
          </button>
          <img src="logo.png" alt="Sungabha Awasiya Ma.Vi. Logo" class="w-10 h-10 rounded-full shadow-lg">
          <div>
            <h2 class="font-bold text-[#1C2526] text-lg">Sungabha Chat</h2>
            <div id="activeUsersCount" class="text-sm text-[#808080] flex items-center">
              <div class="w-2 h-2 bg-[#FFD700] rounded-full animate-pulse mr-2"></div>
              <span id="userCount">0</span> users online
            </div>
          </div>
        </div>
        <div class="flex space-x-2">
          <button id="startAudioCallBtn" class="p-2 hover:bg-[#FFFDD0] rounded-full transition-colors">
            <i class="fas fa-phone text-[#1C2526] text-lg"></i>
          </button>
          <button id="startVideoCallBtn" class="p-2 hover:bg-[#FFFDD0] rounded-full transition-colors">
            <i class="fas fa-video text-[#1C2526] text-lg"></i>
          </button>
          <button id="profileBtn" class="p-2 hover:bg-[#FFFDD0] rounded-full transition-colors">
            <i class="fas fa-user-cog text-[#1C2526] text-lg"></i>
          </button>
          <button id="showUsersBtn" class="p-2 hover:bg-[#FFFDD0] rounded-full transition-colors lg:hidden">
            <i class="fas fa-users text-[#1C2526] text-lg"></i>
          </button>
          <button id="settingsBtn" class="p-2 hover:bg-[#FFFDD0] rounded-full transition-colors">
            <i class="fas fa-cog text-[#1C2526] text-lg"></i>
          </button>
        </div>
      </div>
      <div id="pinnedMessages" class="hidden glass-dark mx-4 mt-2 p-3 rounded-xl"></div>
      <div id="chatMessages" class="flex-1 overflow-y-auto p-4 custom-scrollbar bg-[#FFFDD0]/90 pb-24"></div>
      <div id="replyPreview" class="hidden mx-4 mb-2 p-3 glass rounded-xl flex items-center justify-between">
        <span class="text-[#F5F5F5] text-sm">Replying to: <span id="replyText" class="font-medium"></span></span>
        <button id="cancelReply" class="text-[#8B0000] hover:text-[#FFD700]"><i class="fas fa-times"></i></button>
      </div>
      <div id="typingIndicator" class="hidden px-4 pb-2">
        <div class="typing-dots">
          <div class="typing-dot bg-[#8B0000]"></div>
          <div class="typing-dot bg-[#8B0000]"></div>
          <div class="typing-dot bg-[#8B0000]"></div>
          <span id="typingText" class="ml-2 text-sm text-[#808080]"></span>
        </div>
      </div>
      <div class="sticky bottom-0 bg-[#F5F5F5] backdrop-blur-xl border-t border-[#808080] p-4 z-20 flex flex-col gap-2">
        <div class="flex items-center gap-2">
          <label for="fileInput" class="cursor-pointer bg-[#8B0000] text-[#FFFDD0] w-10 h-10 rounded-full flex items-center justify-center hover:bg-[#FFD700] hover:text-[#1C2526] transition-all">
            <i class="fas fa-paperclip"></i>
            <input id="fileInput" type="file" class="hidden" accept="image/*">
          </label>
          <div id="filePreview" class="hidden flex-1 p-2 bg-[#FFFDD0] rounded flex items-center gap-2"></div>
        </div>
        <div class="flex items-center gap-2">
          <input 
            type="text" 
            id="messageInput" 
            placeholder="Type a message..." 
            class="flex-1 px-4 py-3 rounded-xl bg-[#FFFDD0] text-[#1C2526] border-2 border-transparent focus:border-[#FFD700] focus:bg-[#F5F5F5] shadow-md text-sm"
            maxlength="1000"
          >
          <button id="sendBtn" class="bg-[#8B0000] text-[#FFFDD0] w-12 h-12 rounded-full flex items-center justify-center hover:bg-[#FFD700] hover:text-[#1C2526] transition-all disabled:opacity-50 disabled:cursor-not-allowed" title="Send Message">
            <i id="sendBtnIcon" class="fas fa-paper-plane text-lg"></i>
          </button>
        </div>
        <div class="text-xs text-[#808080] mt-2 text-right">
          <span id="charCount">0</span>/1000
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="hidden fixed inset-0 bg-[#1C2526]/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="glass rounded-2xl p-6 w-full max-w-[320px] shadow-2xl">
      <h3 class="font-bold text-xl text-[#FFFDD0] mb-4 flex items-center">
        <i class="fas fa-user-edit mr-3"></i>
        Edit Profile
      </h3>
      <div class="relative mb-4">
        <input 
          id="newNameInput" 
          type="text" 
          placeholder="New display name" 
          class="w-full px-4 py-3 pl-12 rounded-xl bg-[#F5F5F5] text-[#1C2526] border-2 border-transparent focus:border-[#FFD700] focus:bg-[#FFFDD0] shadow-md text-sm"
          maxlength="30"
        >
        <i class="fas fa-user absolute left-4 top-1/2 transform -translate-y-1/2 text-[#808080]"></i>
      </div>
      <div class="flex justify-end space-x-3">
        <button id="saveNameBtn" class="bg-[#8B0000] text-[#FFFDD0] py-2 px-6 rounded-xl hover:bg-[#FFD700] hover:text-[#1C2526] transition-all text-sm">
          <i class="fas fa-check mr-2"></i>Save
        </button>
        <button id="closeModalBtn" class="py-2 px-6 rounded-xl border border-[#808080] text-[#F5F5F5] hover:bg-[#B0C4DE] hover:text-[#1C2526] transition-all text-sm">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Edit Message Modal -->
  <div id="editModal" class="hidden fixed inset-0 bg-[#1C2526]/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="glass rounded-2xl p-6 w-full max-w-[320px] shadow-2xl">
      <h3 class="font-bold text-xl text-[#FFFDD0] mb-4">Edit Message</h3>
      <input id="editInput" type="text" class="w-full px-4 py-3 rounded-xl bg-[#F5F5F5] text-[#1C2526] border-2 border-transparent focus:border-[#FFD700] focus:bg-[#FFFDD0] shadow-md text-sm mb-4" maxlength="1000">
      <div class="flex justify-end space-x-3">
        <button id="saveEditBtn" class="bg-[#8B0000] text-[#FFFDD0] py-2 px-6 rounded-xl hover:bg-[#FFD700] hover:text-[#1C2526] transition-all text-sm">
          <i class="fas fa-check mr-2"></i>Save
        </button>
        <button id="closeEditBtn" class="py-2 px-6 rounded-xl border border-[#808080] text-[#F5F5F5] hover:bg-[#B0C4DE] hover:text-[#1C2526] transition-all text-sm">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Reaction Modal -->
  <div id="reactionModal" class="hidden fixed inset-0 bg-[#1C2526]/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="glass rounded-2xl p-6 w-full max-w-[320px] shadow-2xl">
      <h3 class="font-bold text-xl text-[#FFFDD0] mb-4 text-center">Choose Reaction</h3>
      <div class="flex gap-4 justify-center mb-4 flex-wrap">
        <button class="reaction-btn text-2xl p-3 rounded-full hover:bg-[#B0C4DE] transition-all" data-reaction="👍">👍</button>
        <button class="reaction-btn text-2xl p-3 rounded-full hover:bg-[#B0C4DE] transition-all" data-reaction="❤️">❤️</button>
        <button class="reaction-btn text-2xl p-3 rounded-full hover:bg-[#B0C4DE] transition-all" data-reaction="😂">😂</button>
        <button class="reaction-btn text-2xl p-3 rounded-full hover:bg-[#B0C4DE] transition-all" data-reaction="😢">😢</button>
        <button class="reaction-btn text-2xl p-3 rounded-full hover:bg-[#B0C4DE] transition-all" data-reaction="😡">😡</button>
        <button class="reaction-btn text-2xl p-3 rounded-full hover:bg-[#B0C4DE] transition-all" data-reaction="🔥">🔥</button>
      </div>
      <div class="flex justify-center">
        <button id="closeReactionModal" class="py-2 px-6 rounded-xl border border-[#808080] text-[#F5F5F5] hover:bg-[#B0C4DE] hover:text-[#1C2526] transition-all text-sm">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="hidden fixed inset-0 bg-[#1C2526]/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="glass rounded-2xl p-6 w-full max-w-[400px] shadow-2xl">
      <h3 class="font-bold text-xl text-[#FFFDD0] mb-4 flex items-center">
        <i class="fas fa-cog mr-3"></i>
        Settings
      </h3>
      <div class="space-y-4">
        <div class="flex items-center justify-between">
          <span class="text-[#F5F5F5] text-sm">Sound Notifications</span>
          <label class="settings-toggle">
            <input id="soundToggle" type="checkbox" checked>
            <span class="slider"></span>
          </label>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-[#F5F5F5] text-sm">Auto-scroll</span>
          <label class="settings-toggle">
            <input id="autoScrollToggle" type="checkbox" checked>
            <span class="slider"></span>
          </label>
        </div>
        <hr class="border-[#808080]">
        <button id="exportChatBtn" class="w-full py-2 px-4 rounded-xl border border-[#808080] text-[#F5F5F5] hover:bg-[#B0C4DE] hover:text-[#1C2526] transition-all text-sm">
          <i class="fas fa-download mr-2"></i>Export Chat History
        </button>
        <button id="clearChatBtn" class="w-full py-2 px-4 rounded-xl border border-[#8B0000] text-[#8B0000] hover:bg-[#8B0000] hover:text-[#FFFDD0] transition-all text-sm">
          <i class="fas fa-trash mr-2"></i>Clear Chat History
        </button>
      </div>
      <div class="flex justify-end mt-6">
        <button id="closeSettingsBtn" class="py-2 px-6 rounded-xl border border-[#808080] text-[#F5F5F5] hover:bg-[#B0C4DE] hover:text-[#1C2526] transition-all text-sm">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Incoming Call Modal -->
  <div id="incomingCallModal" class="hidden fixed inset-0 bg-[#1C2526]/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="glass rounded-2xl p-6 w-full max-w-[320px] shadow-2xl text-center">
      <h3 class="font-bold text-xl text-[#FFFDD0] mb-4">Incoming Call</h3>
      <p id="callerName" class="text-[#F5F5F5] mb-6 text-sm"></p>
      <div class="flex justify-center gap-4">
        <button id="acceptCallBtn" class="bg-[#FFD700] text-[#1C2526] py-2 px-6 rounded-xl hover:bg-[#8B0000] hover:text-[#FFFDD0] transition-all text-sm">
          <i class="fas fa-phone mr-2"></i>Accept
        </button>
        <button id="rejectCallBtn" class="bg-[#8B0000] text-[#FFFDD0] py-2 px-6 rounded-xl hover:bg-[#FFD700] hover:text-[#1C2526] transition-all text-sm">
          <i class="fas fa-phone-slash mr-2"></i>Reject
        </button>
      </div>
    </div>
  </div>

  <!-- Call Overlay -->
  <div id="callOverlay" class="hidden fixed inset-0 bg-black z-40 flex flex-col">
    <div id="remoteVideos" class="flex-1 video-grid p-4"></div>
    <div class="absolute bottom-20 right-4 w-40 h-30 bg-black rounded shadow-lg overflow-hidden">
      <video id="localVideo" autoplay playsinline muted class="local-video"></video>
    </div>
    <div class="bg-[#1C2526]/80 p-4 flex justify-center gap-6 items-center">
      <button id="toggleAudioBtn" class="call-control-btn"><i class="fas fa-microphone"></i></button>
      <button id="toggleVideoBtn" class="call-control-btn"><i class="fas fa-video"></i></button>
      <button id="shareScreenBtn" class="call-control-btn"><i class="fas fa-desktop"></i></button>
      <button id="addParticipantBtn" class="call-control-btn"><i class="fas fa-user-plus"></i></button>
      <button id="endCallBtn" class="call-control-btn bg-[#8B0000]"><i class="fas fa-phone-slash"></i></button>
    </div>
  </div>

  <!-- Select Users Modal -->
  <div id="selectUsersModal" class="hidden fixed inset-0 bg-[#1C2526]/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="glass rounded-2xl p-6 w-full max-w-[400px] shadow-2xl">
      <h3 class="font-bold text-xl text-[#FFFDD0] mb-4">Select Users for Call</h3>
      <div id="selectUsersList" class="space-y-2 max-h-60 overflow-y-auto"></div>
      <div class="flex justify-end mt-4 gap-2">
        <button id="confirmSelectBtn" class="bg-[#8B0000] text-[#FFFDD0] py-2 px-6 rounded-xl hover:bg-[#FFD700] hover:text-[#1C2526] transition-all text-sm">Confirm</button>
        <button id="cancelSelectBtn" class="py-2 px-6 rounded-xl border border-[#808080] text-[#F5F5F5] hover:bg-[#B0C4DE] hover:text-[#1C2526] transition-all text-sm">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Firebase Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, onDisconnect, serverTimestamp, get, update, remove, onChildAdded } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendEmailVerification, updateProfile, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCoKAoarWlu8B6cnIw549hfg_UPe8YRSko",
      authDomain: "nepchat-aac9d.firebaseapp.com",
      databaseURL: "https://nepchat-aac9d-default-rtdb.firebaseio.com",
      projectId: "nepchat-aac9d",
      storageBucket: "nepchat-aac9d.firebasestorage.app",
      messagingSenderId: "179485804786",
      appId: "1:179485804786:web:3ec8a2fc563b08c682286b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let currentUser = null;
    let currentDisplayName = null;
    let currentUsername = null;
    let typingTimeout;
    let activeUsers = {};
    let registeredUsers = {};
    let typingUsers = {};
    let isSignUp = true;
    let replyToId = null;
    let editMessageId = null;
    let reactionMessageId = null;
    let touchStartX = 0;
    let touchEndX = 0;
    let settings = JSON.parse(localStorage.getItem('chatSettings')) || {
      soundNotifications: true,
      autoScroll: true
    };
    let localStream = null;
    let currentCallId = null;
    let peerConnections = {};
    let isVideoEnabled = true;
    let isAudioEnabled = true;
    let isScreenSharing = false;
    let callType = null;
    let currentParticipants = [];

    const EDIT_TIME_LIMIT = 5 * 60 * 1000;
    const IMGBB_API_KEY = 'fdeb5290f70387fcaabd7fb9fbe6d6ca';
    const MAX_FILE_SIZE = 32 * 1024 * 1024; // 32 MB

    const homeScreen = document.getElementById('homeScreen');
    const verificationScreen = document.getElementById('verificationScreen');
    const chatScreen = document.getElementById('chatContainer');
    const nameWrapper = document.getElementById('nameWrapper');
    const usernameInput = document.getElementById('usernameInput');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const passwordToggle = document.getElementById('passwordToggle');
    const authBtn = document.getElementById('authBtn');
    const toggleAuth = document.getElementById('toggleAuth');
    const googleBtn = document.getElementById('googleBtn');
    const authMessage = document.getElementById('authMessage');
    const verificationMessage = document.getElementById('verificationMessage');
    const resendBtn = document.getElementById('resendBtn');
    const backToLoginBtn = document.getElementById('backToLoginBtn');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const sendBtnIcon = document.getElementById('sendBtnIcon');
    const fileInput = document.getElementById('fileInput');
    const filePreview = document.getElementById('filePreview');
    const charCount = document.getElementById('charCount');
    const backBtn = document.getElementById('backBtn');
    const profileBtn = document.getElementById('profileBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const profileModal = document.getElementById('profileModal');
    const settingsModal = document.getElementById('settingsModal');
    const newNameInput = document.getElementById('newNameInput');
    const saveNameBtn = document.getElementById('saveNameBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    const replyPreview = document.getElementById('replyPreview');
    const replyText = document.getElementById('replyText');
    const cancelReply = document.getElementById('cancelReply');
    const editModal = document.getElementById('editModal');
    const editInput = document.getElementById('editInput');
    const saveEditBtn = document.getElementById('saveEditBtn');
    const closeEditBtn = document.getElementById('closeEditBtn');
    const reactionModal = document.getElementById('reactionModal');
    const closeReactionModal = document.getElementById('closeReactionModal');
    const pinnedMessages = document.getElementById('pinnedMessages');
    const usersPanel = document.getElementById('usersPanel');
    const showUsersBtn = document.getElementById('showUsersBtn');
    const activeUsersList = document.getElementById('activeUsersList');
    const inactiveUsersList = document.getElementById('inactiveUsersList');
    const startAudioCallBtn = document.getElementById('startAudioCallBtn');
    const startVideoCallBtn = document.getElementById('startVideoCallBtn');
    const incomingCallModal = document.getElementById('incomingCallModal');
    const callerName = document.getElementById('callerName');
    const acceptCallBtn = document.getElementById('acceptCallBtn');
    const rejectCallBtn = document.getElementById('rejectCallBtn');
    const callOverlay = document.getElementById('callOverlay');
    const localVideo = document.getElementById('localVideo');
    const remoteVideos = document.getElementById('remoteVideos');
    const toggleAudioBtn = document.getElementById('toggleAudioBtn');
    const toggleVideoBtn = document.getElementById('toggleVideoBtn');
    const shareScreenBtn = document.getElementById('shareScreenBtn');
    const addParticipantBtn = document.getElementById('addParticipantBtn');
    const endCallBtn = document.getElementById('endCallBtn');
    const selectUsersModal = document.getElementById('selectUsersModal');
    const selectUsersList = document.getElementById('selectUsersList');
    const confirmSelectBtn = document.getElementById('confirmSelectBtn');
    const cancelSelectBtn = document.getElementById('cancelSelectBtn');

    initializeEventListeners();

    function initializeEventListeners() {
      authBtn.addEventListener('click', handleAuth);
      toggleAuth.addEventListener('click', toggleAuthMode);
      googleBtn.addEventListener('click', signInWithGoogle);
      resendBtn.addEventListener('click', resendVerification);
      backToLoginBtn.addEventListener('click', backToLogin);
      passwordToggle.addEventListener('click', togglePassword);
      showUsersBtn.addEventListener('click', toggleUsersPanel);
      backBtn.addEventListener('click', goBack);
      sendBtn.addEventListener('click', sendMessage);
      messageInput.addEventListener('keydown', handleMessageInput);
      messageInput.addEventListener('input', updateCharCount);
      fileInput.addEventListener('change', previewFile);
      profileBtn.addEventListener('click', openProfileModal);
      settingsBtn.addEventListener('click', openSettingsModal);
      closeModalBtn.addEventListener('click', () => profileModal.classList.add('hidden'));
      closeSettingsBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
      saveNameBtn.addEventListener('click', saveNewName);
      cancelReply.addEventListener('click', cancelReplyMessage);
      closeEditBtn.addEventListener('click', () => editModal.classList.add('hidden'));
      saveEditBtn.addEventListener('click', saveEditedMessage);
      closeReactionModal.addEventListener('click', () => reactionModal.classList.add('hidden'));
      document.addEventListener('click', handleReactionClick);
      document.getElementById('soundToggle').addEventListener('change', () => toggleSetting('soundNotifications'));
      document.getElementById('autoScrollToggle').addEventListener('change', () => toggleSetting('autoScroll'));
      document.getElementById('exportChatBtn').addEventListener('click', exportChat);
      document.getElementById('clearChatBtn').addEventListener('click', clearChat);
      startAudioCallBtn.addEventListener('click', () => startCallSelection('audio'));
      startVideoCallBtn.addEventListener('click', () => startCallSelection('video'));
      acceptCallBtn.addEventListener('click', acceptIncomingCall);
      rejectCallBtn.addEventListener('click', rejectIncomingCall);
      toggleAudioBtn.addEventListener('click', toggleAudio);
      toggleVideoBtn.addEventListener('click', toggleVideo);
      shareScreenBtn.addEventListener('click', toggleScreenShare);
      addParticipantBtn.addEventListener('click', () => startCallSelection(callType, true));
      endCallBtn.addEventListener('click', leaveCall);
      confirmSelectBtn.addEventListener('click', confirmUserSelection);
      cancelSelectBtn.addEventListener('click', () => selectUsersModal.classList.add('hidden'));
      preventMobileZoom();
    }

    function toggleUsersPanel() {
      if (usersPanel.classList.contains('open')) {
        usersPanel.classList.remove('open');
        setTimeout(() => {
          usersPanel.classList.add('hidden');
        }, 300);
      } else {
        usersPanel.classList.remove('hidden');
        setTimeout(() => {
          usersPanel.classList.add('open');
        }, 0);
      }
    }

    function preventMobileZoom() {
      document.addEventListener('gesturestart', (e) => e.preventDefault());
      let lastTouchEnd = 0;
      document.addEventListener('touchend', (e) => {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) e.preventDefault();
        lastTouchEnd = now;
      });
    }

    function sanitizeUsername(username) {
      return username.replace(/[.#$[\]]/g, '_');
    }

    function togglePassword() {
      const isPassword = passwordInput.type === 'password';
      passwordInput.type = isPassword ? 'text' : 'password';
      passwordToggle.className = `fas fa-${isPassword ? 'eye-slash' : 'eye'} absolute right-4 top-1/2 transform -translate-y-1/2 text-[#B0C4DE] cursor-pointer hover:text-[#FFD700] p-2`;
    }

    function toggleAuthMode() {
      isSignUp = !isSignUp;
      if (isSignUp) {
        nameWrapper.classList.remove('hidden');
        authBtn.innerHTML = '<i class="fas fa-rocket mr-2"></i> Create Account';
        toggleAuth.textContent = 'Already have an account? Sign In';
      } else {
        nameWrapper.classList.add('hidden');
        authBtn.innerHTML = '<i class="fas fa-rocket mr-2"></i> Sign In';
        toggleAuth.textContent = "Don't have an account? Sign Up";
      }
      clearAuthMessage();
      authBtn.disabled = false;
    }

    async function handleAuth() {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();

      if (!validateInput(email, password)) return;

      setLoadingState(authBtn, true, 'Processing...');

      try {
        if (isSignUp) {
          const name = usernameInput.value.trim();
          if (!name) {
            showAuthMessage('Please enter your name.', true);
            return;
          }
          await signUp(name, email, password);
        } else {
          await signIn(email, password);
        }
      } catch (error) {
        showAuthMessage(getErrorMessage(error), true);
      } finally {
        setLoadingState(authBtn, false, isSignUp ? 'Create Account' : 'Sign In');
      }
    }

    function validateInput(email, password) {
      if (!email || !email.includes('@') || !email.includes('.')) {
        showAuthMessage('Please enter a valid email address.', true);
        return false;
      }
      if (!password || password.length < 6) {
        showAuthMessage('Password must be at least 6 characters long.', true);
        return false;
      }
      return true;
    }

    async function signUp(name, email, password) {
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        await updateProfile(user, { displayName: name });
        
        const username = sanitizeUsername(email.split('@')[0]);
        await set(ref(db, `usernames/${username}`), { 
          uid: user.uid,
          email: email,
          displayName: name 
        });

        await sendEmailVerification(user);
        showVerificationScreen(user.email);
      } catch (error) {
        if (error.code === 'auth/email-already-in-use') {
          showAuthMessage('This email is already registered. Try signing in instead.', true);
        } else {
          throw error;
        }
      }
    }

    async function signIn(email, password) {
      await signInWithEmailAndPassword(auth, email, password);
    }

    async function signInWithGoogle() {
      setLoadingState(googleBtn, true, 'Processing...');
      try {
        const provider = new GoogleAuthProvider();
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        
        const username = sanitizeUsername(user.email.split('@')[0]);
        await set(ref(db, `usernames/${username}`), { 
          uid: user.uid,
          email: user.email,
          displayName: user.displayName 
        });
      } catch (error) {
        showAuthMessage(getErrorMessage(error), true);
      } finally {
        setLoadingState(googleBtn, false, 'Sign in with Google');
      }
    }

    async function resendVerification() {
      if (!auth.currentUser) {
        showVerificationMessage('Please sign in first.', true);
        return;
      }
      
      setLoadingState(resendBtn, true, 'Sending...');
      try {
        await sendEmailVerification(auth.currentUser);
        showVerificationMessage('Verification email sent! Please check your inbox.', false);
      } catch (error) {
        showVerificationMessage(getErrorMessage(error), true);
      } finally {
        setLoadingState(resendBtn, false, 'Resend Verification Email');
      }
    }

    async function backToLogin() {
      verificationScreen.classList.add('hidden');
      homeScreen.classList.remove('hidden');
      clearAuthMessage();
      clearVerificationMessage();
      if (auth.currentUser) {
        await signOut(auth);
      }
    }

    function showVerificationScreen(email) {
      homeScreen.classList.add('hidden');
      chatScreen.classList.add('hidden');
      verificationScreen.classList.remove('hidden');
      showVerificationMessage(`Verification email sent to ${email}. Please check your inbox and don't forget to check the spam section.`, false);
    }

    function showAuthMessage(message, isError) {
      authMessage.textContent = message;
      authMessage.className = `text-center text-sm mt-4 p-3 rounded-lg ${isError ? 'bg-[#8B0000] text-[#FFFDD0] border border-[#FFD700]' : 'bg-[#FFD700] text-[#1C2526] border border-[#8B0000]'}`;
      authMessage.classList.remove('hidden');
      setTimeout(() => clearAuthMessage(), 5000);
    }

    function showVerificationMessage(message, isError) {
      verificationMessage.textContent = message;
      verificationMessage.className = `text-center text-sm mt-4 p-3 rounded-lg ${isError ? 'bg-[#8B0000] text-[#FFFDD0] border border-[#FFD700]' : 'bg-[#FFD700] text-[#1C2526] border border-[#8B0000]'}`;
      verificationMessage.classList.remove('hidden');
      if (!isError) setTimeout(() => clearVerificationMessage(), 8000);
    }

    function clearAuthMessage() {
      authMessage.classList.add('hidden');
    }

    function clearVerificationMessage() {
      verificationMessage.classList.add('hidden');
    }

    function getErrorMessage(error) {
      const errorMessages = {
        'auth/user-not-found': 'No account found with this email.',
        'auth/wrong-password': 'Incorrect password.',
        'auth/email-already-in-use': 'Email already registered.',
        'auth/weak-password': 'Password is too weak.',
        'auth/invalid-email': 'Invalid email address.',
        'auth/user-disabled': 'Account has been disabled.',
        'auth/too-many-requests': 'Too many attempts. Try again later.',
      };
      return errorMessages[error.code] || error.message;
    }

    function setLoadingState(button, loading, text) {
      if (button === sendBtn) {
        sendBtn.disabled = loading;
        sendBtnIcon.className = `fas ${loading ? 'fa-spinner fa-spin' : 'fa-paper-plane'} text-lg`;
        sendBtn.title = loading ? 'Sending...' : 'Send Message';
      } else {
        button.disabled = loading;
        button.innerHTML = loading ? `<i class="fas fa-spinner fa-spin mr-2"></i> ${text}` : `<i class="fas fa-rocket mr-2"></i> ${text}`;
      }
    }

    onAuthStateChanged(auth, (user) => {
      if (user) {
        if (user.emailVerified) {
          currentUser = user;
          currentDisplayName = user.displayName || user.email.split('@')[0];
          currentUsername = sanitizeUsername(user.email.split('@')[0]);
          
          showChatScreen();
          joinChat();
          setupWebRTCListeners();
          setTimeout(() => messageInput.focus(), 300);
        } else {
          showVerificationScreen(user.email);
        }
      } else {
        currentUser = null;
        currentDisplayName = null;
        currentUsername = null;
        showHomeScreen();
      }
    });

    function showChatScreen() {
      homeScreen.classList.add('hidden');
      verificationScreen.classList.add('hidden');
      chatScreen.classList.remove('hidden');
      usersPanel.classList.remove('hidden');
    }

    function showHomeScreen() {
      chatScreen.classList.add('hidden');
      verificationScreen.classList.add('hidden');
      homeScreen.classList.remove('hidden');
      resetAuthForm();
    }

    function resetAuthForm() {
      usernameInput.value = '';
      emailInput.value = '';
      passwordInput.value = '';
      clearAuthMessage();
      clearVerificationMessage();
    }

    async function goBack() {
      if (currentCallId) leaveCall();
      if (currentUser) {
        await Promise.all([
          set(ref(db, `activeUsers/${currentUser.uid}`), null),
          set(ref(db, `typing/${currentUser.uid}`), null)
        ]);
      }
      try {
        await signOut(auth);
      } catch (error) {
        console.error('Sign out error:', error);
      }
    }

    function joinChat() {
      const userRef = ref(db, `activeUsers/${currentUser.uid}`);
      const userStatus = {
        name: currentDisplayName,
        username: currentUsername,
        joinedAt: serverTimestamp(),
        status: 'online',
        lastSeen: serverTimestamp()
      };
      
      set(userRef, userStatus);
      onDisconnect(userRef).set({
        ...userStatus,
        status: 'offline',
        lastSeen: serverTimestamp()
      });

      const typingRef = ref(db, `typing/${currentUser.uid}`);
      set(typingRef, false);
      onDisconnect(typingRef).remove();

      setupRealtimeListeners();
    }

    function setupRealtimeListeners() {
      const usersRef = ref(db, 'activeUsers');
      onValue(usersRef, (snapshot) => {
        activeUsers = snapshot.val() || {};
        updateUsersPanel();
      });

      const registeredRef = ref(db, 'usernames');
      onValue(registeredRef, (snapshot) => {
        registeredUsers = snapshot.val() || {};
        updateUsersPanel();
      });

      const messagesRef = ref(db, 'messages');
      onValue(messagesRef, (snapshot) => {
        const messagesDiv = document.getElementById('chatMessages');
        const wasAtBottom = isScrolledToBottom(messagesDiv);
        
        messagesDiv.innerHTML = '';
        const data = snapshot.val() || {};
        const sortedMessages = Object.entries(data)
          .map(([key, value]) => ({ id: key, ...value }))
          .sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
          
        sortedMessages.forEach(msg => addMessage(msg));
        
        if (settings.autoScroll && wasAtBottom) {
          scrollToBottom();
        }
      }, (error) => {
        console.error('Error listening to messages:', error);
        showTemporaryError('Failed to load messages.');
      });

      const typingAllRef = ref(db, 'typing');
      onValue(typingAllRef, (snapshot) => {
        typingUsers = snapshot.val() || {};
        updateTypingIndicator();
      });

      const pinnedRef = ref(db, 'pinnedMessages');
      onValue(pinnedRef, (snapshot) => {
        updatePinnedMessages(snapshot.val() || {});
      });
    }

    function updateUsersPanel() {
      const activeList = document.getElementById('activeUsersList');
      const inactiveList = document.getElementById('inactiveUsersList');
      activeList.innerHTML = '';
      inactiveList.innerHTML = '';

      const userCount = Object.values(activeUsers).filter(user => user.status === 'online').length;
      document.getElementById('userCount').textContent = userCount;

      Object.entries(activeUsers).forEach(([uid, userData]) => {
        if (userData.status === 'online') {
          const userBadge = createUserBadge(userData, true);
          activeList.appendChild(userBadge);
        }
      });

      Object.entries(registeredUsers).forEach(([username, userData]) => {
        const uid = userData.uid;
        if (!activeUsers[uid] || activeUsers[uid].status === 'offline') {
          const badgeData = {
            name: userData.displayName,
            username: username,
            status: 'offline'
          };
          const userBadge = createUserBadge(badgeData, false);
          inactiveList.appendChild(userBadge);
        }
      });
    }

    function createUserBadge(userData, isOnline) {
      const userBadge = document.createElement('div');
      userBadge.className = `flex items-center gap-2 bg-[#F5F5F5]/90 rounded-full p-2 text-sm font-medium text-[#1C2526] cursor-pointer hover:bg-[#FFFDD0] transition-all shadow-md ${isOnline ? 'animate-pulse' : ''}`;
      
      const statusColor = isOnline ? 'bg-[#FFD700]' : 'bg-[#808080]';
      
      userBadge.innerHTML = `
        <div class="w-2 h-2 ${statusColor} rounded-full"></div>
        <span>${escapeHtml(userData.name)}</span>
        <span class="text-xs text-[#808080]">@${escapeHtml(userData.username)}</span>
      `;
      
      userBadge.addEventListener('click', () => {
        messageInput.value += `@${userData.username} `;
        messageInput.focus();
        if (window.innerWidth < 1024) toggleUsersPanel();
      });
      
      return userBadge;
    }

    function previewFile() {
      const file = fileInput.files[0];
      if (!file) return;

      filePreview.innerHTML = '';
      const cancel = document.createElement('button');
      cancel.innerHTML = '<i class="fas fa-times"></i>';
      cancel.className = 'text-[#8B0000] hover:text-[#FFD700] p-1';
      cancel.onclick = () => { 
        fileInput.value = ''; 
        filePreview.innerHTML = ''; 
        filePreview.classList.add('hidden'); 
        updateCharCount(); 
      };
      filePreview.appendChild(cancel);

      if (file.type.startsWith('image/')) {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        img.className = 'max-w-20 max-h-20 rounded object-cover shadow-md';
        filePreview.appendChild(img);
      }

      const span = document.createElement('span');
      span.textContent = file.name;
      span.className = 'text-[#1C2526] truncate max-w-xs';
      filePreview.appendChild(span);

      filePreview.classList.remove('hidden');
      updateCharCount();
    }

    async function sendMessage() {
      const text = messageInput.value.trim();
      let fileUrl = null;
      let fileType = null;
      let fileName = null;

      if (fileInput.files[0]) {
        const file = fileInput.files[0];
        if (file.size > MAX_FILE_SIZE) {
          showTemporaryError('File size exceeds 32 MB limit.');
          return;
        }

        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/bmp', 'image/tiff', 'image/webp', 'image/heic'];
        if (!allowedTypes.includes(file.type)) {
          showTemporaryError('Only image files (JPG, PNG, GIF, BMP, TIFF, WebP, HEIC) are supported.');
          return;
        }

        setLoadingState(sendBtn, true, 'Uploading...');

        try {
          const reader = new FileReader();
          await new Promise((resolve, reject) => {
            reader.onload = resolve;
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });
          const base64Image = reader.result.split(',')[1];

          const formData = new FormData();
          formData.append('key', IMGBB_API_KEY);
          formData.append('image', base64Image);
          formData.append('name', file.name);

          const response = await fetch('https://api.imgbb.com/1/upload', {
            method: 'POST',
            body: formData
          });

          const result = await response.json();
          if (!result.success) {
            throw new Error(result.error?.message || 'Image upload failed.');
          }

          fileUrl = result.data.url;
          fileType = file.type;
          fileName = file.name;
        } catch (error) {
          console.error('Image upload error:', error);
          showTemporaryError('Failed to upload image: ' + error.message);
          setLoadingState(sendBtn, false, 'Send');
          return;
        }
      }

      if (!text && !fileUrl) return;

      const messageText = text || fileName;

      const messageData = {
        user: currentDisplayName,
        username: currentUsername,
        text: messageText,
        timestamp: Date.now(),
        replyTo: replyToId,
        deleted: false,
        edited: false,
        type: fileUrl ? 'file' : 'text'
      };

      if (fileUrl) {
        messageData.fileUrl = fileUrl;
        messageData.fileType = fileType;
        messageData.fileName = fileName;
      }

      try {
        const newMessageRef = await push(ref(db, 'messages'), messageData);
        messageInput.value = '';
        fileInput.value = '';
        filePreview.innerHTML = '';
        filePreview.classList.add('hidden');
        updateCharCount();
        updateTyping(false);
        cancelReplyMessage();
        if (settings.soundNotifications) {
          playNotificationSound();
        }
        setLoadingState(sendBtn, false, 'Send');
      } catch (error) {
        console.error('Error sending message:', error);
        showTemporaryError(`Failed to send message: ${error.message}`);
        setLoadingState(sendBtn, false, 'Send');
      }
    }

    function handleMessageInput(e) {
      updateTyping(true);
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => updateTyping(false), 2000);
      
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    }

    function updateCharCount() {
      const count = messageInput.value.length;
      charCount.textContent = count;
      sendBtn.disabled = (count === 0 && !fileInput.value);
      
      charCount.className = count > 800 ? 'text-[#8B0000]' : count > 600 ? 'text-[#FFD700]' : 'text-[#808080]';
    }

    function updateTyping(status) {
      if (currentUser) {
        set(ref(db, `typing/${currentUser.uid}`), status ? currentDisplayName : false);
      }
    }

    function showTemporarySuccess(message) {
      const toast = document.createElement('div');
      toast.className = 'toast toast-success';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function showTemporaryError(message) {
      const toast = document.createElement('div');
      toast.className = 'toast toast-error';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function addMessage(msg) {
      try {
        const chatDiv = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        const isCurrentUser = msg.username === currentUsername;
        const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        messageDiv.className = `message-appear`;
        messageDiv.dataset.id = msg.id;

        let content = '';
        if (msg.deleted) {
          content = '<div class="text-[#808080] italic text-sm">This message was deleted</div>';
        } else {
          content = '<div class="message-content">';
          if (msg.fileUrl) {
            const isImage = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'].includes(msg.fileType);
            const linkText = msg.fileName || 'Attached file';
            content += `
              <div class="file-message">
                ${isImage ? `<img src="${escapeHtml(msg.fileUrl)}" alt="${escapeHtml(linkText)}" class="shadow-md">` : ''}
                <a href="${escapeHtml(msg.fileUrl)}" target="_blank" rel="noopener noreferrer">${escapeHtml(linkText)}</a>
              </div>
            `;
          }
          const showText = msg.text && !(msg.fileUrl && msg.text === msg.fileName);
          if (showText) {
            content += `<div class="leading-relaxed ${msg.fileUrl ? 'mt-2' : ''}">${parseMentions(escapeHtml(msg.text))}</div>`;
          }
          content += '</div>';
          if (msg.replyTo) {
            addQuotedMessage(messageDiv, msg.replyTo);
          }
        }

        let reactionsHtml = '';
        if (msg.reactions) {
          reactionsHtml = buildReactionsHtml(msg.reactions, isCurrentUser, msg.id);
        }

        let readReceipt = buildReadReceipt(msg, isCurrentUser);

        messageDiv.innerHTML = `
          <div class="message-bubble ${isCurrentUser ? 'sent' : 'received'}">
            ${!isCurrentUser ? `<div class="text-xs font-semibold ${isCurrentUser ? 'text-[#FFFDD0]' : 'text-[#4169E1]'} mb-1">${escapeHtml(msg.user)}</div>` : ''}
            ${content}
            <div class="text-xs ${isCurrentUser ? 'text-[#FFFDD0]/70' : 'text-[#808080]'} mt-2 flex items-center justify-end gap-1">
              ${time}
              ${msg.edited ? '<span class="italic">edited</span>' : ''}
              ${readReceipt}
            </div>
          </div>
          ${reactionsHtml}
        `;
        
        const bubble = messageDiv.querySelector('.message-bubble');
        bubble.addEventListener('touchstart', handleTouchStart, { passive: true });
        bubble.addEventListener('touchmove', handleTouchMove, { passive: true });
        bubble.addEventListener('touchend', (e) => handleTouchEnd(e, msg.id, msg.text || msg.fileUrl), { passive: true });

        addMessageActions(messageDiv, msg, isCurrentUser);
        
        chatDiv.appendChild(messageDiv);
        
        if (!isCurrentUser && !msg.views?.[currentUser.uid]) {
          markMessageAsViewed(msg.id);
        }
      } catch (error) {
        console.error('Error adding message:', error);
        showTemporaryError('Failed to display message.');
      }
    }

    function addMessageActions(messageDiv, msg, isCurrentUser) {
      try {
        const actionsDiv = document.createElement('div');
        actionsDiv.className = `message-actions ${isCurrentUser ? 'sent' : 'received'}`;
        let actionsHtml = `
          <i class="fas fa-reply action-icon" onclick="replyToMessage('${msg.id}', '${escapeHtml(msg.text || msg.fileName || '')}')"></i>
          <i class="fas fa-smile action-icon" onclick="openReactionModal('${msg.id}')"></i>
          <i class="fas fa-thumbtack action-icon" onclick="pinMessage('${msg.id}')"></i>
        `;
        if (isCurrentUser && !msg.deleted && msg.type !== 'file') {
          actionsHtml += `
            <i class="fas fa-edit action-icon" onclick="editMessage('${msg.id}', '${escapeHtml(msg.text)}', ${msg.timestamp})"></i>
            <i class="fas fa-trash action-icon" onclick="deleteMessage('${msg.id}')"></i>
          `;
        }
        actionsDiv.innerHTML = actionsHtml;
        messageDiv.appendChild(actionsDiv);
      } catch (error) {
        console.error('Error adding message actions:', error);
        showTemporaryError('Failed to add message actions.');
      }
    }

    function buildReactionsHtml(reactions, isCurrentUser, msgId) {
      const reactionCounts = {};
      Object.entries(reactions).forEach(([userId, reaction]) => {
        reactionCounts[reaction] = (reactionCounts[reaction] || 0) + 1;
      });
      
      let html = `<div class="flex gap-2 mt-2 ${isCurrentUser ? 'justify-end' : 'justify-start'}">`;
      Object.entries(reactionCounts).forEach(([reaction, count]) => {
        html += `<span onclick="openReactionModal('${msgId}')" class="reactions-display bg-[#F5F5F5]/20 backdrop-blur-sm rounded-full px-2 py-1 text-sm flex items-center gap-1 cursor-pointer">
          ${reaction} <span class="text-xs">${count}</span>
        </span>`;
      });
      html += '</div>';
      return html;
    }

    async function addQuotedMessage(messageDiv, replyToId) {
      try {
        const snap = await get(ref(db, `messages/${replyToId}`));
        const repliedMsg = snap.val();
        if (repliedMsg && !repliedMsg.deleted) {
          const quoteDiv = document.createElement('div');
          quoteDiv.className = 'bg-[#1C2526]/10 border-l-4 border-[#FFD700] p-2 mb-2 rounded text-sm';
          const text = repliedMsg.type === 'file' ? `[File: ${repliedMsg.text}]` : repliedMsg.text;
          quoteDiv.innerHTML = `<strong>${escapeHtml(repliedMsg.user)}</strong>: ${escapeHtml(text.substring(0, 100))}${text.length > 100 ? '...' : ''}`;
          messageDiv.querySelector('.message-content')?.insertAdjacentElement('afterbegin', quoteDiv);
        }
      } catch (error) {
        console.error('Error loading quoted message:', error);
      }
    }

    function buildReadReceipt(msg, isCurrentUser) {
      if (!isCurrentUser) return '';
      
      const totalActiveUsers = Object.keys(activeUsers).length;
      const viewCount = msg.views ? Object.keys(msg.views).length : 0;
      
      if (viewCount >= totalActiveUsers - 1) {
        return '<i class="fas fa-check-double text-[#FFD700]"></i>';
      } else if (viewCount > 0) {
        return '<i class="fas fa-check text-[#FFD700]"></i>';
      }
      return '';
    }

    function parseMentions(text) {
      return text.replace(/@(\w+)/g, '<span class="font-semibold text-[#FFD700]">@$1</span>');
    }

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function markMessageAsViewed(messageId) {
      if (currentUser) {
        set(ref(db, `messages/${messageId}/views/${currentUser.uid}`), serverTimestamp());
      }
    }

    window.editMessage = function(id, text, timestamp) {
      if (Date.now() - timestamp > EDIT_TIME_LIMIT) {
        showTemporaryError('Edit time limit exceeded (5 minutes).');
        return;
      }
      editMessageId = id;
      editInput.value = text;
      editModal.classList.remove('hidden');
      editInput.focus();
    }

    function saveEditedMessage() {
      const newText = editInput.value.trim();
      if (!newText) {
        showTemporaryError('Message cannot be empty.');
        return;
      }
      update(ref(db, `messages/${editMessageId}`), {
        text: newText,
        edited: true
      }).then(() => {
        editModal.classList.add('hidden');
        editInput.value = '';
        editMessageId = null;
        showTemporarySuccess('Message edited successfully.');
      }).catch(error => {
        console.error('Error editing message:', error);
        showTemporaryError('Failed to edit message: ' + error.message);
      });
    }

    window.deleteMessage = function(id) {
      update(ref(db, `messages/${id}`), { deleted: true })
        .then(() => {
          showTemporarySuccess('Message deleted successfully.');
        })
        .catch(error => {
          console.error('Error deleting message:', error);
          showTemporaryError('Failed to delete message: ' + error.message);
        });
    }

    window.replyToMessage = function(id, text) {
      replyToId = id;
      replyText.textContent = text.length > 50 ? text.substring(0, 50) + '...' : text;
      replyPreview.classList.remove('hidden');
      messageInput.focus();
    }

    function cancelReplyMessage() {
      replyToId = null;
      replyPreview.classList.add('hidden');
      replyText.textContent = '';
    }

    window.openReactionModal = function(id) {
      reactionMessageId = id;
      reactionModal.classList.remove('hidden');
    }

    function handleReactionClick(e) {
      if (e.target.classList.contains('reaction-btn')) {
        const reaction = e.target.dataset.reaction;
        if (reactionMessageId && currentUser) {
          set(ref(db, `messages/${reactionMessageId}/reactions/${currentUser.uid}`), reaction)
            .then(() => {
              reactionModal.classList.add('hidden');
              reactionMessageId = null;
            })
            .catch(error => {
              console.error('Error adding reaction:', error);
              showTemporaryError('Failed to add reaction: ' + error.message);
            });
        }
      }
    }

    window.pinMessage = function(id) {
      set(ref(db, `pinnedMessages/${id}`), true)
        .then(() => {
          showTemporarySuccess('Message pinned successfully.');
        })
        .catch(error => {
          console.error('Error pinning message:', error);
          showTemporaryError('Failed to pin message: ' + error.message);
        });
    }

    function updatePinnedMessages(pinned) {
      pinnedMessages.innerHTML = '';
      if (Object.keys(pinned).length === 0) {
        pinnedMessages.classList.add('hidden');
        return;
      }
      pinnedMessages.classList.remove('hidden');
      Object.keys(pinned).forEach(async (msgId) => {
        try {
          const snap = await get(ref(db, `messages/${msgId}`));
          const msg = snap.val();
          if (msg && !msg.deleted) {
            const pinDiv = document.createElement('div');
            pinDiv.className = 'pinned-message bg-[#FFFDD0]/90 rounded-xl p-2 mb-2 text-sm cursor-pointer';
            pinDiv.innerHTML = `
              <div class="flex items-center justify-between">
                <span><strong>${escapeHtml(msg.user)}</strong>: ${escapeHtml(msg.text || msg.fileName || '')}</span>
                <button onclick="unpinMessage('${msgId}')" class="text-[#8B0000] hover:text-[#FFD700]">
                  <i class="fas fa-thumbtack"></i>
                </button>
              </div>
            `;
            pinDiv.addEventListener('click', () => {
              const messageElement = document.querySelector(`[data-id="${msgId}"]`);
              if (messageElement) {
                messageElement.scrollIntoView({ behavior: 'smooth' });
              }
            });
            pinnedMessages.appendChild(pinDiv);
          }
        } catch (error) {
          console.error('Error loading pinned message:', error);
        }
      });
    }

    window.unpinMessage = function(id) {
      remove(ref(db, `pinnedMessages/${id}`))
        .then(() => {
          showTemporarySuccess('Message unpinned successfully.');
        })
        .catch(error => {
          console.error('Error unpinning message:', error);
          showTemporaryError('Failed to unpin message: ' + error.message);
        });
    }

    function openProfileModal() {
      newNameInput.value = currentDisplayName;
      profileModal.classList.remove('hidden');
      newNameInput.focus();
    }

    function openSettingsModal() {
      document.getElementById('soundToggle').checked = settings.soundNotifications;
      document.getElementById('autoScrollToggle').checked = settings.autoScroll;
      settingsModal.classList.remove('hidden');
    }

    function saveNewName() {
      const newName = newNameInput.value.trim();
      if (!newName) {
        showTemporaryError('Name cannot be empty.');
        return;
      }
      updateProfile(auth.currentUser, { displayName: newName })
        .then(() => {
          return set(ref(db, `usernames/${currentUsername}`), {
            uid: currentUser.uid,
            email: currentUser.email,
            displayName: newName
          });
        })
        .then(() => {
          currentDisplayName = newName;
          profileModal.classList.add('hidden');
          showTemporarySuccess('Name updated successfully.');
        })
        .catch(error => {
          console.error('Error updating name:', error);
          showTemporaryError('Failed to update name: ' + error.message);
        });
    }

    function toggleSetting(setting) {
      settings[setting] = !settings[setting];
      localStorage.setItem('chatSettings', JSON.stringify(settings));
    }

    function exportChat() {
      get(ref(db, 'messages')).then(snapshot => {
        const messages = snapshot.val() || {};
        const exportData = Object.entries(messages)
          .map(([id, msg]) => ({
            id,
            user: msg.user,
            text: msg.text,
            timestamp: new Date(msg.timestamp).toLocaleString(),
            fileUrl: msg.fileUrl || null,
            replyTo: msg.replyTo || null,
            deleted: msg.deleted || false
          }));
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'sungabha_chat_export.json';
        a.click();
        URL.revokeObjectURL(url);
        showTemporarySuccess('Chat history exported successfully.');
      }).catch(error => {
        console.error('Error exporting chat:', error);
        showTemporaryError('Failed to export chat history.');
      });
    }

    function clearChat() {
      if (confirm('Are you sure you want to clear all chat history? This cannot be undone.')) {
        remove(ref(db, 'messages')).then(() => {
          showTemporarySuccess('Chat history cleared successfully.');
        }).catch(error => {
          console.error('Error clearing chat:', error);
          showTemporaryError('Failed to clear chat history: ' + error.message);
        });
      }
    }

    function playNotificationSound() {
      const audio = new Audio('https://freesound.org/data/previews/316/316847_4939433-lq.mp3');
      audio.play().catch(error => console.error('Error playing sound:', error));
    }

    function isScrolledToBottom(el) {
      return el.scrollHeight - el.scrollTop - el.clientHeight < 10;
    }

    function scrollToBottom() {
      const chatDiv = document.getElementById('chatMessages');
      chatDiv.scrollTo({ top: chatDiv.scrollHeight, behavior: 'smooth' });
    }

    function updateTypingIndicator() {
      const typingIndicator = document.getElementById('typingIndicator');
      const typingText = document.getElementById('typingText');
      const typingUsersList = Object.entries(typingUsers)
        .filter(([uid, name]) => name && uid !== currentUser.uid)
        .map(([_, name]) => name);
      
      if (typingUsersList.length > 0) {
        typingText.textContent = `${typingUsersList.join(', ')} ${typingUsersList.length > 1 ? 'are' : 'is'} typing...`;
        typingIndicator.classList.remove('hidden');
      } else {
        typingIndicator.classList.add('hidden');
      }
    }

    function handleTouchStart(e) {
      touchStartX = e.touches[0].clientX;
    }

    function handleTouchMove(e) {
      touchEndX = e.touches[0].clientX;
    }

    function handleTouchEnd(e, msgId, msgText) {
      const swipeDistance = touchStartX - touchEndX;
      if (Math.abs(swipeDistance) > 50) {
        replyToMessage(msgId, msgText);
      }
    }

    // WebRTC Functions
    function setupWebRTCListeners() {
      const invitationsRef = ref(db, `invitations/${currentUser.uid}`);
      onValue(invitationsRef, (snap) => {
        const invites = snap.val();
        if (invites) {
          const inviteIds = Object.keys(invites);
          if (inviteIds.length > 0) {
            const firstInviteId = inviteIds[0];
            const invite = invites[firstInviteId];
            get(ref(db, `activeUsers/${invite.from}`)).then((userSnap) => {
              const caller = userSnap.val();
              callerName.textContent = `${caller.name} is calling you (${invite.type} call)`;
              incomingCallModal.dataset.callId = firstInviteId;
              incomingCallModal.dataset.type = invite.type;
              incomingCallModal.classList.remove('hidden');
            }).catch(error => {
              console.error('Error fetching caller:', error);
            });
          }
        }
      });
    }

    function acceptIncomingCall() {
      const callId = incomingCallModal.dataset.callId;
      const type = incomingCallModal.dataset.type;
      incomingCallModal.classList.add('hidden');
      joinCall(callId, type);
      remove(ref(db, `invitations/${currentUser.uid}/${callId}`));
    }

    function rejectIncomingCall() {
      const callId = incomingCallModal.dataset.callId;
      incomingCallModal.classList.add('hidden');
      remove(ref(db, `invitations/${currentUser.uid}/${callId}`));
    }

    let isAddingParticipant = false;

    function startCallSelection(type, adding = false) {
      isAddingParticipant = adding;
      callType = type;
      const excludeUids = adding ? currentParticipants : [currentUser.uid];
      const availableUsers = Object.entries(activeUsers).filter(([uid, data]) => data.status === 'online' && !excludeUids.includes(uid)).length;
      if (availableUsers === 0) {
        showTemporaryError(`No ${adding ? 'additional' : 'other'} active users available for the call.`);
        return;
      }
      selectUsersModal.classList.remove('hidden');
      populateSelectUsers(excludeUids);
      confirmSelectBtn.textContent = adding ? 'Add' : 'Start Call';
    }

    function populateSelectUsers(excludeUids) {
      selectUsersList.innerHTML = '';
      Object.entries(activeUsers).forEach(([uid, userData]) => {
        if (userData.status === 'online' && !excludeUids.includes(uid)) {
          const div = document.createElement('div');
          div.className = 'flex items-center gap-2 p-2 hover:bg-[#B0C4DE] rounded cursor-pointer';
          div.innerHTML = `
            <input type="checkbox" class="select-user-checkbox" data-uid="${uid}" />
            <span>${escapeHtml(userData.name)} (@${escapeHtml(userData.username)})</span>
          `;
          selectUsersList.appendChild(div);
        }
      });
      // Limit to 3 selections
      selectUsersList.addEventListener('change', (e) => {
        if (e.target.type === 'checkbox') {
          const checked = Array.from(selectUsersList.querySelectorAll('.select-user-checkbox:checked'));
          if (checked.length > 3) {
            e.target.checked = false;
            showTemporaryError('Maximum 3 users can be selected.');
          }
        }
      });
    }

    function confirmUserSelection() {
      const selected = Array.from(selectUsersList.querySelectorAll('.select-user-checkbox:checked')).map(cb => cb.dataset.uid);
      if (selected.length === 0) {
        showTemporaryError('Select at least one user.');
        return;
      }
      selectUsersModal.classList.add('hidden');
      if (isAddingParticipant) {
        selected.forEach(uid => sendInvitation(uid, currentCallId, callType));
      } else {
        createCall(callType, selected);
      }
    }

    async function createCall(type, invitedUids) {
      try {
        const callRef = push(ref(db, 'calls'));
        const callId = callRef.key;
        await set(callRef, {
          type,
          creator: currentUser.uid,
          createdAt: serverTimestamp()
        });
        await set(ref(db, `calls/${callId}/participants/${currentUser.uid}`), serverTimestamp());
        invitedUids.forEach(async (uid) => {
          await sendInvitation(uid, callId, type);
        });
        joinCall(callId, type);
      } catch (error) {
        console.error('Error creating call:', error);
        showTemporaryError('Failed to create call.');
      }
    }

    async function sendInvitation(toUid, callId, type) {
      try {
        await set(ref(db, `invitations/${toUid}/${callId}`), {
          from: currentUser.uid,
          type,
          timestamp: serverTimestamp()
        });
      } catch (error) {
        console.error('Error sending invitation:', error);
        showTemporaryError('Failed to send invitation.');
      }
    }

    async function joinCall(callId, type) {
      try {
        currentCallId = callId;
        callType = type;
        const constraints = {
          audio: true,
          video: type === 'video' ? { width: { ideal: 640 }, height: { ideal: 480 } } : false
        };
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        localVideo.srcObject = localStream;
        callOverlay.classList.remove('hidden');
        await set(ref(db, `calls/${callId}/participants/${currentUser.uid}`), serverTimestamp());
        setupCallListeners(callId);
        toggleVideoBtn.classList.toggle('hidden', type !== 'video');
        shareScreenBtn.classList.toggle('hidden', type !== 'video');
      } catch (error) {
        console.error('Error joining call:', error);
        showTemporaryError('Failed to join call: ' + error.message);
      }
    }

    function setupCallListeners(callId) {
      const participantsRef = ref(db, `calls/${callId}/participants`);
      onValue(participantsRef, (snap) => {
        const participants = snap.val() || {};
        currentParticipants = Object.keys(participants);
        currentParticipants.forEach(peerUid => {
          if (peerUid !== currentUser.uid && !peerConnections[peerUid]) {
            createPeerConnection(callId, peerUid);
          }
        });
        // Clean up removed participants
        Object.keys(peerConnections).forEach(uid => {
          if (!currentParticipants.includes(uid)) {
            peerConnections[uid].close();
            delete peerConnections[uid];
            removeRemoteVideo(uid);
          }
        });
        // If no other participants, leave call
        if (currentParticipants.length <= 1) {
          leaveCall();
        }
      });
    }

    function createPeerConnection(callId, peerUid) {
      const config = {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun.stunprotocol.org:3478' }
        ]
      };
      const pc = new RTCPeerConnection(config);
      pc.addEventListener('icecandidate', (e) => {
        if (e.candidate) {
          push(ref(db, `calls/${callId}/candidates/${currentUser.uid}_to_${peerUid}`), e.candidate.toJSON());
        }
      });
      pc.addEventListener('track', (e) => {
        addRemoteVideo(peerUid, e.streams[0]);
      });
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      peerConnections[peerUid] = pc;

      // Listen for signaling
      const pairKey = [currentUser.uid, peerUid].sort().join('_to_');
      const signalingRef = ref(db, `calls/${callId}/signaling/${pairKey}`);
      onValue(signalingRef, (snap) => {
        const data = snap.val();
        if (data) {
          if (data.offer && !pc.remoteDescription && data.initiator !== currentUser.uid) {
            pc.setRemoteDescription(new RTCSessionDescription(data.offer)).then(() => {
              return pc.createAnswer();
            }).then(answer => {
              pc.setLocalDescription(answer);
              update(ref(db, `calls/${callId}/signaling/${pairKey}`), { answer });
            }).catch(error => {
              console.error('Error handling offer:', error);
            });
          } else if (data.answer && pc.signalingState === 'have-local-offer') {
            pc.setRemoteDescription(new RTCSessionDescription(data.answer)).catch(error => {
              console.error('Error setting answer:', error);
            });
          }
        }
      });

      // Send offer if initiator
      if (currentUser.uid < peerUid) {
        pc.createOffer().then(offer => {
          pc.setLocalDescription(offer);
          set(ref(db, `calls/${callId}/signaling/${pairKey}`), { offer, initiator: currentUser.uid });
        }).catch(error => {
          console.error('Error creating offer:', error);
        });
      }

      // Listen for candidates
      const candidatesRef = ref(db, `calls/${callId}/candidates/${peerUid}_to_${currentUser.uid}`);
      onChildAdded(candidatesRef, (snap) => {
        const candidate = new RTCIceCandidate(snap.val());
        pc.addIceCandidate(candidate).catch(error => {
          console.error('Error adding ICE candidate:', error);
        });
      });
    }

    function addRemoteVideo(uid, stream) {
      let container = document.getElementById(`remote-container-${uid}`);
      if (!container) {
        container = document.createElement('div');
        container.className = 'relative';
        container.id = `remote-container-${uid}`;
        const video = document.createElement('video');
        video.className = 'remote-video';
        video.autoplay = true;
        video.playsinline = true;
        video.srcObject = stream;
        container.appendChild(video);
        const label = document.createElement('div');
        label.className = 'absolute bottom-2 left-2 bg-black/50 text-white p-1 rounded text-sm';
        label.textContent = activeUsers[uid]?.name || 'Unknown';
        container.appendChild(label);
        remoteVideos.appendChild(container);
      } else {
        container.querySelector('video').srcObject = stream;
      }
    }

    function removeRemoteVideo(uid) {
      const container = document.getElementById(`remote-container-${uid}`);
      if (container) container.remove();
    }

    function toggleAudio() {
      isAudioEnabled = !isAudioEnabled;
      localStream.getAudioTracks().forEach(track => track.enabled = isAudioEnabled);
      toggleAudioBtn.classList.toggle('disabled', !isAudioEnabled);
    }

    function toggleVideo() {
      isVideoEnabled = !isVideoEnabled;
      localStream.getVideoTracks().forEach(track => track.enabled = isVideoEnabled);
      toggleVideoBtn.classList.toggle('disabled', !isVideoEnabled);
    }

    async function toggleScreenShare() {
      try {
        if (isScreenSharing) {
          const screenTrack = localStream.getVideoTracks().find(track => track.label.toLowerCase().includes('screen'));
          if (screenTrack) {
            screenTrack.stop();
            localStream.removeTrack(screenTrack);
          }
          // Restore camera if was enabled
          if (isVideoEnabled && callType === 'video') {
            const cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
            const cameraTrack = cameraStream.getVideoTracks()[0];
            localStream.addTrack(cameraTrack);
            Object.values(peerConnections).forEach(pc => {
              const sender = pc.getSenders().find(s => s.track?.kind === 'video');
              if (sender) sender.replaceTrack(cameraTrack);
            });
          }
          isScreenSharing = false;
          shareScreenBtn.classList.remove('disabled');
        } else {
          const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
          const screenTrack = screenStream.getVideoTracks()[0];
          localStream.addTrack(screenTrack);
          Object.values(peerConnections).forEach(pc => {
            const sender = pc.getSenders().find(s => s.track?.kind === 'video');
            if (sender) sender.replaceTrack(screenTrack);
          });
          screenTrack.onended = toggleScreenShare;
          isScreenSharing = true;
          shareScreenBtn.classList.add('disabled');
        }
      } catch (error) {
        console.error('Error sharing screen:', error);
        showTemporaryError('Failed to share screen.');
      }
    }

    async function leaveCall() {
      try {
        Object.values(peerConnections).forEach(pc => pc.close());
        peerConnections = {};
        if (localStream) {
          localStream.getTracks().forEach(track => track.stop());
          localStream = null;
        }
        callOverlay.classList.add('hidden');
        remoteVideos.innerHTML = '';
        await remove(ref(db, `calls/${currentCallId}/participants/${currentUser.uid}`));
        currentCallId = null;
        callType = null;
        currentParticipants = [];
        isScreenSharing = false;
        isAudioEnabled = true;
        isVideoEnabled = true;
      } catch (error) {
        console.error('Error leaving call:', error);
        showTemporaryError('Failed to leave call.');
      }
    }
  </script>
</body>
</html>